<!DOCTYPE html>
<html>
  <head>
    <meta
      http-equiv="Content-Type"
      content="text/html;charset=UTF-8"
    />
    <title>1st Project</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"
    />
    <meta
      name="apple-mobile-web-app-capable"
      content="yes"
    />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black"
    />
    <meta
      property="og:title"
      content="1st Project"
    />
    <meta
      property="og:description"
      content=""
    />
    <meta
      name="mobile-web-app-capable"
      content="yes"
    />
    <meta
      property="og:image"
      content="preview.jpg"
    />
    <style>
      /* Fullscreen styles */
      html {
        height: 100%;
      }
      body {
        height: 100%;
        margin: 0;
        background: black;
        color: white;
        overflow: hidden; /* Disable scrollbars */
        -webkit-tap-highlight-color: rgba(
          0,
          0,
          0,
          0
        ); /* Remove highlight on tap */
      }
      /* Custom scrollbar styles */
      ::-webkit-scrollbar {
        background-color: rgba(0, 0, 0, 0.5);
        width: 0.75em;
        height: 0.75em;
      }
      ::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.5);
      }
    </style>
  </head>
  <body>
    <script
      type="text/javascript"
      src="pano2vr_player.js?ts=68917192"
    ></script>
    <script
      type="text/javascript"
      src="skin.js?ts=68917192"
    ></script>
    <div
      id="container"
      style="width: 100%; height: 100%; overflow: hidden"
    >
      <br />Loading...<br /><br />
    </div>

    <script type="text/javascript">
      localStorage.setItem("testKey", "testValue");
      console.log("localStorage test value:", localStorage.getItem("testKey"));

      // Function to parse URL hash parameters
      function parseParams(paramsString, params) {
        paramsString = paramsString.substring(1);
        var firstSeparatorPos = paramsString.indexOf(",");
        if (firstSeparatorPos !== -1) {
          params.startNode = paramsString.slice(0, firstSeparatorPos);
          var viewingParamsString = paramsString.slice(firstSeparatorPos + 1);
          var viewingParams = viewingParamsString.split(",");
          if (viewingParams.length >= 3) {
            params.startView = {
              pan: viewingParams[0],
              tilt: viewingParams[1],
              fov: viewingParams[2],
              projection: viewingParams[3] || undefined,
            };
          }
        } else {
          params.startNode = paramsString;
          params.startView = "";
        }
      }

      var params = {};
      parseParams(document.location.hash, params);
      var startNode = params.startNode || getLastNode();
      if (!startNode) {
        startNode = "node6";
        console.log("No startNode found. Falling back to default:", startNode);
      }
      console.log("startNode:", startNode);
      console.log("Last saved node in localStorage:", getLastNode());

      var startView = params.startView;

      var pano = new pano2vrPlayer("container");
      pano.setQueryParameter("ts=68917192");

      pano.on("nodechanged", function () {
        var currentNode = pano.getCurrentNode();
        console.log("Node changed to:", currentNode);
        saveLastNode(currentNode);
      });

      pano.on("hotspotclicked", function (hotspotId) {
        console.log("Hotspot clicked. ID:", hotspotId);

        var nodeId = pano.getHotspotUrl(hotspotId);
        if (nodeId) {
          nodeId = nodeId.replace("{", "").replace("}", "");
          console.log("Navigating to nodeId:", nodeId);
          saveLastNode(nodeId);
        } else {
          console.warn("No nodeId found for hotspot:", hotspotId);
        }
      });

      var skin = new pano2vrSkin(pano);

      window.addEventListener("load", function () {
        pano.readConfigUrlAsync("pano.xml?ts=68917192", function () {
          console.log("pano.xml loaded successfully!");

          pano.on("hotspotclicked", function (hotspotId) {
            console.log("Hotspot clicked. ID:", hotspotId);

            var nodeId = pano.getHotspotUrl(hotspotId);
            if (nodeId) {
              nodeId = nodeId.replace("{", "").replace("}", "");
              console.log("Navigating to nodeId:", nodeId);
              saveLastNode(nodeId);
            } else {
              console.warn("No URL found for hotspot:", hotspotId);
            }
          });
        });
      });

      function saveLastNode(nodeId) {
        console.log(`Attempting to save node: ${nodeId}`);
        try {
          localStorage.setItem("lastViewedNode", nodeId);
          console.log("Node saved to localStorage:", nodeId);
        } catch (e) {
          console.error("Failed to save to localStorage:", e);
        }
      }

      function getLastNode() {
        const lastNode = localStorage.getItem("lastViewedNode");
        console.log("Retrieved last node from localStorage:", lastNode);
        return lastNode;
      }

      // Safari fix for white borders and rotation issues
      if (window.navigator.userAgent.match(/Safari/i)) {
        function iosHfix() {
          window.scrollTo(0, 1);
          var container = document.getElementById("container");
          var oh = container.offsetHeight;
          document.documentElement.style.setProperty("height", "100vh");
          if (oh !== container.offsetHeight) {
            container.style.setProperty("height", "100%");
          } else {
            container.style.setProperty("height", window.innerHeight + "px");
          }
          window.scrollTo(0, 0);
          pano.setViewerSize(container.offsetWidth, container.offsetHeight);
        }
        setTimeout(iosHfix, 0);
        setTimeout(iosHfix, 100);
        window.addEventListener("resize", function () {
          setTimeout(iosHfix, 0);
          setTimeout(iosHfix, 500);
          setTimeout(iosHfix, 1000);
          setTimeout(iosHfix, 2000);
        });
      }
    </script>

    <noscript>
      <p><b>Please enable JavaScript!</b></p>
    </noscript>
  </body>
</html>
